rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    
    // ========================
    // Dispute Evidence Uploads
    // Path: /evidence/{disputeId}/{fileName}
    // ========================
    match /evidence/{disputeId}/{fileName} {
      
      // Renter who owns the dispute can upload/view their own files
      allow read, write: if request.auth != null && isDisputeOwner(disputeId);

      // Admins and Super Admins can view/manage all evidence
      allow read, write: if request.auth != null && (isAdminOrSuper());
    }

    // ========================
    // Public assets (e.g., blog images, site logos)
    // Path: /public/{fileName}
    // ========================
    match /public/{fileName} {
      allow read: if true;   // anyone can view
      allow write: if isAdminOrSuper(); // only admins can upload
    }

    // ========================
    // Helper functions
    // ========================
    function isSuperAdmin() {
      return request.auth != null &&
        get(/databases/(default)/documents/users/$(request.auth.uid)).data.role == "SUPER_ADMIN";
    }

    function isAdminOrSuper() {
      return request.auth != null &&
        (
          get(/databases/(default)/documents/users/$(request.auth.uid)).data.role == "ADMIN" ||
          get(/databases/(default)/documents/users/$(request.auth.uid)).data.role == "SUPER_ADMIN"
        );
    }

    function isDisputeOwner(disputeId) {
      return request.auth != null &&
        get(/databases/(default)/documents/disputes/$(disputeId)).data.renter == request.auth.uid;
    }
  }
}
