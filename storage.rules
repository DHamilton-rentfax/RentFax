rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {

    // Evidence files are immutable. They can be created, but never overwritten or deleted.
    // Access is granted only through signed URLs generated by the backend, which has its own logic.
    match /evidence/{evidenceId}/{fileName} {
      // Allow write (upload) only if the user is authenticated and the file does not already exist.
      // This prevents overwriting evidence.
      allow create: if request.auth != null;

      // Disallow updates and deletes completely to ensure immutability.
      allow update, delete: if false;

      // Read access should ONLY be granted via Signed URLs. Disallow direct reads.
      allow read: if false;
    }

    // Allow users to upload to a temp directory if needed, can be cleaned up later.
    // This is not part of the core evidence system but good practice.
    match /temp/{userId}/{fileName} {
        allow write: if request.auth != null && request.auth.uid == userId;
        allow read: if request.auth != null && request.auth.uid == userId;
    }
    
    // General user profile pictures, etc.
    match /users/{userId}/{fileName} {
      allow read: if true; // Publicly readable profile pics
      allow write: if request.auth != null && request.auth.uid == userId;
    }
  }
}
