name: 🚀 RentFAX CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
    steps:
      - name: 🧾 Checkout Repo
        uses: actions/checkout@v4

      - name: 🧰 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: 📦 Install Dependencies
        run: npm ci

      - name: 🔧 Install Firebase CLI
        run: npm install -g firebase-tools

      - name: 🏗️ Build Next.js App
        run: npm run build

      - name: 🔥 Deploy to Firebase Hosting (Staging)
        run: |
          firebase use ${{ secrets.FIREBASE_PROJECT_ID }}
          firebase deploy --only hosting:rentfax-staging --token "${{ secrets.FIREBASE_TOKEN }}"

      - name: 🔥 Deploy to Firebase Hosting (Production)
        if: github.ref == 'refs/heads/main'
        run: |
          firebase use ${{ secrets.FIREBASE_PROJECT_ID }}
          firebase deploy --only hosting:rentfax-revamp --token "${{ secrets.FIREBASE_TOKEN }}"

      - name: 🌐 Trigger Vercel Build
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: |
          npm i -g vercel
          vercel --prod --token "${{ secrets.VERCEL_TOKEN }}" --confirm

      - name: 🪵 Log Deployment Event
        run: |
          curl -X POST "https://rentfax-revamp.web.app/api" \
          -H "Content-Type: application/json" \
          -d '{"message":"GitHub Deployment Complete","level":"info","source":"github","meta":{"branch":"${{ github.ref_name }}","actor":"${{ github.actor }}"}}'

      - name: 💬 Notify Slack (optional)
        if: ${{ success() && secrets.SLACK_WEBHOOK_URL != '' }}
        run: |
          curl -X POST -H 'Content-type: application/json' \
          --data "{\"text\":\"✅ RentFAX deployed successfully by *${{ github.actor }}* on branch *${{ github.ref_name }}* 🚀\"}" \
          ${{ secrets.SLACK_WEBHOOK_URL }}
