#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

echo "ğŸ” Checking Firebase imports..."
# This script should be executable, e.g., chmod +x scripts/lint-firebase-imports.js
# npx tsx scripts/lint-firebase-imports.js || exit 1

echo "ğŸ§¹ Checking for .env leaks..."
# Abort if any .env files are staged
if git diff --cached --name-only | grep -E '\.env($|\.local|\.production|\.development)'; then
  echo "âŒ Commit blocked: Found .env file(s) staged for commit!"
  echo "ğŸ‘‰ Please remove them from git tracking:"
  echo "   git restore --staged .env*"
  echo "   and ensure they are listed in .gitignore."
  exit 1
fi
echo "âœ… No .env files staged."

echo "ğŸ›¡ï¸ Checking for server-side code in client components..."
# Block direct imports of 'crypto', 'fs', 'path' in client-side code.
# Allows these imports in files that start with "use server" or are in /api/ or /lib/server-actions/
CLIENT_FILES=$(git diff --cached --name-only -- 'src/app/**/*.ts' 'src/app/**/*.tsx' 'src/components/**/*.ts' 'src/components/**/*.tsx' 'src/hooks/**/*.ts' 'src/hooks/**/*.tsx' | grep -v 'src/app/api/' | xargs -I {} grep -L '"use server"' {})

if [ -n "$CLIENT_FILES" ]; then
    BAD_IMPORTS=$(echo "$CLIENT_FILES" | xargs grep -l -E "import.*from 'crypto'|import.*from 'fs'|import.*from 'path'")
    if [ -n "$BAD_IMPORTS" ]; then
        echo "âŒ Commit blocked: Found server-side Node.js imports in client components!"
        echo "$BAD_IMPORTS"
        echo "\nğŸ‘‰ Move logic using 'crypto', 'fs', or 'path' to a Server Action in '/lib/server-actions/'."
        exit 1
    fi
fi
echo "âœ… No server-side module leaks found."


echo "ğŸ§¼ Running ESLint (optional)..."
npm run lint --if-present

echo "âœ… All pre-commit checks passed!"
