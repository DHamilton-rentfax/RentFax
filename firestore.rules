rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Users Collection ---
    match /users/{userId} {
      
      // 1. Users can read their own document.
      // This is necessary for the app to display the user's current plan, add-ons, etc.
      allow read: if request.auth != null && request.auth.uid == userId;
      
      // 2. Users can create their own document (e.g., at sign-up).
      allow create: if request.auth != null && request.auth.uid == userId;

      // 3. Users can update their document ONLY IF they are not touching billing fields.
      // This allows them to change their name, profile picture, etc., but not their plan.
      allow update: if request.auth != null && request.auth.uid == userId
                    // The following fields can ONLY be changed by the secure webhook.
                    && !('plan' in request.resource.data)
                    && !('addons' in request.resource.data)
                    && !('subscriptionStatus' in request.resource.data)
                    && !('credits' in request.resource.data)
                    && !('stripeCustomerId' in request.resource.data)
                    && !('currentPeriodEnd' in request.resource.data);
    }

    // --- Audit Logs Collection ---
    match /auditLogs/{logId} {
      // Nobody on the client-side can read or write to the audit log.
      // This is a server-only collection, written to by the webhook.
      allow read, write: if false;
    }
  }
}
