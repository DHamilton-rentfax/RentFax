rules_version = '2';
service cloud.firestore {
  match /databases/{db}/documents {

    /* ===============================
       Helper functions
    =============================== */

    function isSignedIn() {
      return request.auth != null;
    }

    function isRole(role) {
      return request.auth != null
        && request.auth.token.role == role;
    }

    function isAnyRole(roles) {
      return request.auth != null
        && request.auth.token.role in roles;
    }
    
    function isAdmin() {
      return request.auth != null &&
        (
          request.auth.token.role == "ADMIN" ||
          request.auth.token.role == "SUPER_ADMIN"
        );
    }
    
    function isActiveMember() {
      return request.auth != null &&
        get(/databases/$(db)/documents/users/$(request.auth.uid))
          .data.membership.status == "active";
    }

    /* ===============================
       Collection Rules
    =============================== */

    // LEDGER (Unaffected)
    match /ledger/{ledgerId} {
      allow read: if isAdmin();
      allow create, update, delete: if false;
    }

    // REPORTS (Unaffected)
    match /reports/{reportId} {
      allow read: if isSignedIn() && isActiveMember() &&
        (
          request.auth.uid == resource.data.renterId ||
          (
            request.auth.token.companyId != null &&
            request.auth.token.companyId == resource.data.companyId
          ) ||
          isAdmin()
        );
      allow create: if isSignedIn() && isAdmin();
      allow update, delete: if false;
    }

    // DISPUTES (FIXED)
    match /disputes/{disputeId} {
      allow create: if isRole("SUPER_ADMIN");
      allow read: if isAnyRole(["SUPER_ADMIN", "ADMIN", "VIEWER"]);
      allow update, delete: if false;
    }

    // EVIDENCE (Unaffected)
    match /evidence/{evidenceId} {
      allow read: if isSignedIn() &&
        (
          request.auth.uid == resource.data.renterId ||
          request.auth.token.companyId == resource.data.companyId ||
          isAdmin()
        );
      allow create: if isSignedIn() &&
        (
          request.auth.uid == request.resource.data.renterId ||
          (
            request.auth.token.companyId != null &&
            request.auth.token.companyId == request.resource.data.companyId
          )
        );
      allow update, delete: if false;
    }

    // SELF VERIFICATIONS (Unaffected)
    match /self_verifications/{token} {
      allow read: if true;
      allow create: if isSignedIn();
      allow update, delete: if false;
    }

    // AUDIT LOGS (FIXED)
    match /auditLogs/{logId} {
      allow read: if isRole("SUPER_ADMIN");
      allow write: if false;
    }

    // AI SUMMARIES (Unaffected)
    match /ai_summaries/{id} {
      allow read: if isSignedIn() &&
        (
          request.auth.uid == resource.data.renterId ||
          request.auth.token.companyId == resource.data.companyId ||
          isAdmin()
        );
      allow create, update, delete: if false;
    }
    
    // RENTERS (FIXED)
    match /renters/{renterId} {
      allow read: if isAnyRole(["SUPER_ADMIN", "ADMIN", "SUPPORT"]);
      allow update: if isAnyRole(["SUPER_ADMIN", "ADMIN"]);
      allow create, delete: if false;
    }

    // MEMBER ID REQUESTS (Unaffected)
    match /memberIdRequests/{requestId} {
      allow read: if request.auth != null;
      allow write: if false; 
    }

    // BLOGS (FIXED)
    match /blogs/{blogId} {
      allow read: if true;
      allow create, update: if isAnyRole(["EDITOR", "SUPER_ADMIN"]);
      allow delete: if isRole("SUPER_ADMIN");
    }

    // INVITES (FIXED)
    match /invites/{inviteId} {
      allow create: if isAnyRole(["ADMIN", "SUPER_ADMIN"]);
      allow read: if isAnyRole(["ADMIN", "SUPER_ADMIN"]);
      allow update, delete: if false;
    }

    // ALERTS (FIXED)
    match /alerts/{alertId} {
      allow read: if isAnyRole(["ADMIN", "SUPPORT"]);
      allow update: if isRole("ADMIN");
      allow create, delete: if false;
    }

    // CHATS (FIXED)
    match /chats/{chatId} {
      allow create: if isAnyRole(["RENTER", "SUPPORT"]);
      allow update: if isAnyRole(["SUPPORT"]);
      allow read: if request.auth != null;
      allow delete: if false;
    }

    /* ===============================
       DEFAULT DENY (MANDATORY)
    =============================== */
    match /{document=**} {
      allow read, write: if false;
    }
  }
}