rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --------------------------------------------------------------------
    // HELPERS
    // --------------------------------------------------------------------

    function isSignedIn() {
      return request.auth != null;
    }

    function role() {
      return request.auth.token.role;
    }

    function isSuperAdmin() {
      return isSignedIn() && role() == "SUPER_ADMIN";
    }

    function isCompanyOrLandlord() {
      return isSignedIn() &&
        (role() == "COMPANY" || role() == "LANDLORD");
    }

    function isLegal() {
      return isSignedIn() && role() == "LEGAL";
    }

    function isRenter(uid) {
      return isSignedIn() && request.auth.uid == uid;
    }

    // --------------------------------------------------------------------
    // COMPANIES
    // --------------------------------------------------------------------
    match /companies/{companyId} {
      allow read: if isSuperAdmin() || isCompanyOrLandlord() && request.auth.uid == companyId;
      allow write: if isSuperAdmin();
    }

    // --------------------------------------------------------------------
    // RENTER PROFILES
    // --------------------------------------------------------------------
    match /renters/{renterId} {
      allow read: if
        isSuperAdmin() ||
        isRenter(renterId) ||
        isCompanyOrLandlord();

      // Renters may update their own profile (BUT ONLY LIMITED FIELDS)
      allow update: if isRenter(renterId)
        && request.resource.data.diff(resource.data).changedKeys()
          .hasOnly(["verified", "identityStatus", "selfieUrl", "idFrontUrl", "idBackUrl"]);

      // Companies/Landlords cannot modify renter identity or core info
      allow update: if isCompanyOrLandlord()
        && request.resource.data.diff(resource.data).changedKeys()
          .hasOnly(["internalNotes", "alert", "alertReasons"]);

      allow delete: if false;
    }

    // --------------------------------------------------------------------
    // RENTER TIMELINE (INCIDENTS + DISPUTES)
    // --------------------------------------------------------------------
    match /renters/{renterId}/timeline/{eventId} {
      allow read: if
        isSuperAdmin() ||
        isRenter(renterId) ||
        isCompanyOrLandlord();

      // Only the server should write timeline events
      allow write: if false;
    }

    // --------------------------------------------------------------------
    // INCIDENTS
    // --------------------------------------------------------------------
    match /incidents/{incidentId} {
      allow read: if
        isSuperAdmin() ||
        isCompanyOrLandlord() ||
        isLegal() ||
        (isSignedIn() && request.auth.uid == resource.data.renterId);

      // Company that created the incident may edit it (not delete it)
      allow update: if isCompanyOrLandlord()
        && request.auth.uid == resource.data.createdBy
        && !("renterId" in request.resource.data)
        && !("companyId" in request.resource.data)
        && !("createdBy" in request.resource.data);

      // Creation allowed for Companies / Landlords / Legal only
      allow create: if isCompanyOrLandlord() || isLegal();

      // Only Super Admin can delete
      allow delete: if isSuperAdmin();
    }

    // --------------------------------------------------------------------
    // DISPUTES
    // --------------------------------------------------------------------
    match /disputes/{disputeId} {
      allow read: if
        isSuperAdmin() ||
        isCompanyOrLandlord() ||
        isLegal() ||
        (isSignedIn() && request.auth.uid == resource.data.renterId);

      // Renter may create disputes for their own profile
      allow create: if isSignedIn()
        && request.resource.data.renterId == request.auth.uid;

      // Companies may update dispute status
      allow update: if isCompanyOrLandlord()
        && request.resource.data.companyId == request.auth.uid;

      allow delete: if isSuperAdmin();
    }

    // --------------------------------------------------------------------
    // AUDIT LOGS (READ-ONLY, SUPER ADMIN ONLY)
    // --------------------------------------------------------------------
    match /audit_logs/{logId} {
      allow read: if isSuperAdmin();
      allow write: if false; // server only
      allow delete: if false;
    }

    // --------------------------------------------------------------------
    // FRAUD FLAGS (READ-ONLY OUTSIDE SERVER)
    // --------------------------------------------------------------------
    match /fraudFlags/{flagId} {
      allow read: if isSuperAdmin();
      allow write: if false; // server-only
      allow delete: if false;
    }

    // --------------------------------------------------------------------
    // VERIFICATION SESSIONS
    // --------------------------------------------------------------------
    match /identity_verification/{sessionId} {
      allow read: if
        isSuperAdmin() ||
        isCompanyOrLandlord() ||
        (isSignedIn() && request.auth.uid == resource.data.renterId);

      allow create: if isCompanyOrLandlord() || isRenter(request.resource.data.renterId);

      allow update: if isRenter(resource.data.renterId);
    }

  }
}