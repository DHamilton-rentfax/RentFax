rules_version = '2';
service cloud.firestore {
  match /databases/{db}/documents {

    /* ======================================================
       AUTH HELPERS
    ====================================================== */

    function isSignedIn() {
      return request.auth != null;
    }

    /* ======================================================
       ROLE RESOLUTION (CLAIMS â†’ FIRESTORE FALLBACK)
    ====================================================== */

    function resolvedRole() {
      return request.auth.token.role != null
        ? request.auth.token.role
        : (
            exists(/databases/$(db)/documents/users/$(request.auth.uid))
              ? get(/databases/$(db)/documents/users/$(request.auth.uid)).data.role
              : null
          );
    }

    function resolvedCompanyId() {
      return request.auth.token.companyId != null
        ? request.auth.token.companyId
        : (
            exists(/databases/$(db)/documents/users/$(request.auth.uid))
              ? get(/databases/$(db)/documents/users/$(request.auth.uid)).data.companyId
              : null
          );
    }

    /* ======================================================
       ROLE CHECKS (NO NULLS)
    ====================================================== */

    function hasRole(role) {
      return isSignedIn() && resolvedRole() == role;
    }

    function isSuperAdmin() {
      return hasRole("SUPER_ADMIN");
    }

    function isAdmin() {
      return hasRole("ADMIN") || hasRole("SUPER_ADMIN");
    }

    function isSupport() {
      return hasRole("SUPPORT");
    }

    function isEditor() {
      return hasRole("EDITOR") || hasRole("SUPER_ADMIN");
    }

    function isViewer() {
      return hasRole("VIEWER");
    }

    function isRenter() {
      return hasRole("RENTER");
    }

    /* ======================================================
       MEMBERSHIP CHECK
    ====================================================== */

    function isActiveMember() {
      return isSignedIn()
        && exists(/databases/$(db)/documents/users/$(request.auth.uid))
        && get(/databases/$(db)/documents/users/$(request.auth.uid))
            .data.membership.status == "active";
    }

    /* ======================================================
       USERS
    ====================================================== */

    match /users/{userId} {
      allow read: if
        (isSignedIn() && request.auth.uid == userId)
        || isAdmin();

      allow create: if
        isSignedIn() && request.auth.uid == userId;

      allow update: if
        (isSignedIn() && request.auth.uid == userId)
        || isAdmin();

      allow delete: if isSuperAdmin();
    }

    /* ======================================================
       LEDGER (READ ONLY)
    ====================================================== */

    match /ledger/{ledgerId} {
      allow read: if isAdmin();
      allow write: if false;
    }

    /* ======================================================
       REPORTS
    ====================================================== */

    match /reports/{reportId} {
      allow read: if
        isSignedIn()
        && isActiveMember()
        && (
          request.auth.uid == resource.data.renterId ||
          (
            resolvedCompanyId() != null &&
            resolvedCompanyId() == resource.data.companyId
          ) ||
          isAdmin()
        );

      allow create: if isAdmin();
      allow update, delete: if false;
    }

    /* ======================================================
       DISPUTES
    ====================================================== */

    match /disputes/{disputeId} {
      allow create: if isSuperAdmin();
      allow read: if isSuperAdmin() || isAdmin() || isViewer();
      allow update, delete: if false;
    }

    /* ======================================================
       EVIDENCE
    ====================================================== */

    match /evidence/{evidenceId} {
      allow read: if
        isSignedIn()
        && (
          request.auth.uid == resource.data.renterId ||
          resolvedCompanyId() == resource.data.companyId ||
          isAdmin()
        );

      allow create: if
        isSignedIn()
        && (
          request.auth.uid == request.resource.data.renterId ||
          (
            resolvedCompanyId() != null &&
            resolvedCompanyId() == request.resource.data.companyId
          )
        );

      allow update, delete: if false;
    }

    /* ======================================================
       SELF VERIFICATIONS (TOKEN SAFE)
    ====================================================== */

    match /self_verifications/{token} {
      allow read: if false;
      allow create: if isSignedIn();
      allow update, delete: if false;
    }

    /* ======================================================
       AUDIT LOGS (IMMUTABLE)
    ====================================================== */

    match /auditLogs/{logId} {
      allow read: if isSuperAdmin();
      allow write: if false;
    }

    /* ======================================================
       AI SUMMARIES
    ====================================================== */

    match /ai_summaries/{id} {
      allow read: if
        isSignedIn()
        && (
          request.auth.uid == resource.data.renterId ||
          resolvedCompanyId() == resource.data.companyId ||
          isAdmin()
        );

      allow write: if false;
    }

    /* ======================================================
       RENTERS
    ====================================================== */

    match /renters/{renterId} {
      allow read: if isSuperAdmin() || isAdmin() || isSupport();
      allow update: if isSuperAdmin() || isAdmin();
      allow create, delete: if false;
    }

    /* ======================================================
       MEMBER ID REQUESTS
    ====================================================== */

    match /memberIdRequests/{requestId} {
      allow create: if
        isSignedIn()
        && request.resource.data.userId == request.auth.uid;

      allow read: if
        (isSignedIn() && resource.data.userId == request.auth.uid)
        || isAdmin();

      allow update, delete: if false;
    }

    /* ======================================================
       BLOGS
    ====================================================== */

    match /blogs/{blogId} {
      allow read: if true;
      allow create, update: if isEditor();
      allow delete: if isSuperAdmin();
    }

    /* ======================================================
       INVITES
    ====================================================== */

    match /invites/{inviteId} {
      allow create, read: if isAdmin();
      allow update, delete: if false;
    }

    /* ======================================================
       ALERTS
    ====================================================== */

    match /alerts/{alertId} {
      allow read: if isAdmin() || isSupport();
      allow update: if isAdmin();
      allow create, delete: if false;
    }

    /* ======================================================
       CHATS (SCOPED)
    ====================================================== */

    match /chats/{chatId} {
      allow create: if isRenter() || isSupport();
      allow update: if isSupport();
      allow read: if
        isSignedIn()
        && (
          request.auth.uid in resource.data.participantIds ||
          isAdmin()
        );
      allow delete: if false;
    }

    /* ======================================================
       DEFAULT DENY
    ====================================================== */

    match /{document=**} {
      allow read, write: if false;
    }
  }
}
