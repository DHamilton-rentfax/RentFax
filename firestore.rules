rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isAuthed() { return request.auth != null; }

    function userDoc() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    function userOrgId() { return userDoc().orgId; }

    function userRole() { return userDoc().role; }

    function isOrgStaff() {
      return userRole() in ["OWNER", "ADMIN", "MANAGER"];
    }

    function entitlementIdFor(renterId) {
      return userOrgId() + "_" + renterId;
    }

    function hasActiveEntitlement(renterId) {
      return exists(/databases/$(database)/documents/entitlements/$(entitlementIdFor(renterId)))
        && get(/databases/$(database)/documents/entitlements/$(entitlementIdFor(renterId))).data.status == "active";
    }

    // --- ENTITLEMENTS ---
    match /entitlements/{entId} {
      // Server only writes
      allow create, update, delete: if false;

      // Org can read its own entitlements (we store orgId as a field)
      allow read: if isAuthed() && isOrgStaff() && resource.data.orgId == userOrgId();
    }

    // --- REPORTS ---
    match /reports/{reportId} {
      // Server only writes
      allow create, update, delete: if false;

      // Read policy:
      // 1) you can read your own org's reports
      // 2) OR you can read reports for this renter if you have an active entitlement
      allow read: if isAuthed()
        && isOrgStaff()
        && (
          resource.data.orgId == userOrgId()
          || hasActiveEntitlement(resource.data.renterId)
        );
    }

    // --- ACCESS LOGS ---
    match /accessLogs/{logId} {
      allow create, update, delete: if false;
      allow read: if isAuthed() && isOrgStaff() && resource.data.orgId == userOrgId();
    }

    // --- RENTERS ---
    match /renters/{renterId} {
      // You can tighten later (some orgs may see only partial renter fields without entitlement).
      // For now keep reads staff-only; entitlement gating can be added similarly if needed.
      allow read: if isAuthed() && isOrgStaff();
      allow write: if false;
    }

    // --- ORGS ---
    match /orgs/{orgId} {
      allow read: if isAuthed() && isOrgStaff() && orgId == userOrgId();
      allow write: if false;

      match /usageDaily/{dayId} {
        allow read: if isAuthed() && isOrgStaff() && orgId == userOrgId();
        allow write: if false;
      }
    }

    // --- USERS ---
    match /users/{userId} {
      allow read: if isAuthed() && userId == request.auth.uid;
      allow write: if false;
    }
  }
}
